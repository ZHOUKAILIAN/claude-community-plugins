# 缺陷需求 005: 缺少强制执行文档驱动开发流程的命令

## 文档信息

- **编号**: BUG-005
- **类型**: 缺陷（Defect）
- **标题**: 缺少强制执行文档驱动开发流程的命令
- **版本**: 1.0.0
- **创建日期**: 2026-01-16
- **状态**: 草案
- **依赖**: REQ-001 (AI Documentation-Driven Development Plugin)
- **关联插件**: ai-doc-driven-dev

## 1. 问题描述

### 1.1 缺陷概述

REQ-001 中定义了完整的文档驱动开发流程（先文档、再代码），并在 CLAUDE.md 中声明了这个规范，但**缺少一个命令来真正强制执行这个流程**。

当前用户可以绕过文档流程直接进行代码变更，AI 也不会主动拦截或引导用户先完成文档。

### 1.2 当前现状

**已实现的能力**：
- ✅ 文档驱动开发流程规范（定义在 CLAUDE.md 中）
- ✅ 文档体系结构（docs/requirements, docs/design, docs/standards 等）
- ✅ 文档初始化命令（init-doc-driven-dev）
- ✅ 文档分析命令（analyze-docs, extract-patterns）
 - ✅ 文档模板基础（需求/技术方案模板）

**存在的问题**：
- ❌ 用户可以直接要求 AI 修改代码，绕过文档流程
- ❌ AI 不会主动检查是否存在对应的需求文档和技术设计文档
- ❌ 缺少一个"执行器"来真正强制执行文档优先原则
- ❌ CLAUDE.md 中的规范只是声明，没有实际的执行机制

### 1.3 问题场景示例

**当前行为（不符合预期）**：

```
用户: "帮我在登录页面添加一个忘记密码的链接"
AI: "好的，我来修改登录页面代码..."
     [直接修改代码，没有要求先写需求文档]
```

**期望行为**：

```
用户: "帮我在登录页面添加一个忘记密码的链接"
AI: "⚠️ 检测到代码变更请求，但未找到对应的需求文档。
     根据文档驱动开发规范，需要先完成以下步骤：

     1️⃣ 创建需求文档：docs/requirements/XXX-forgot-password-link.md
        - 描述功能需求
        - 定义用户交互流程
        - 明确验收标准

     2️⃣ 创建技术设计文档：docs/design/XXX-forgot-password-link-design.md
        - UI 设计方案
        - 路由设计
        - 状态管理方案

     3️⃣ 基于文档进行代码实现

     是否现在开始创建需求文档？[Y/n]"
```

### 1.4 影响范围

- **流程遵守性**：用户可以轻易绕过文档驱动开发流程
- **代码质量**：缺少文档约束的代码变更可能不符合项目规范
- **可追溯性**：代码变更缺少需求和设计文档作为上下文
- **团队协作**：新成员无法通过文档了解变更背景

## 2. 问题根因分析

### 2.1 设计层面

REQ-001 定义的文档驱动开发流程是一个**被动规范**，而不是**主动执行机制**：

- CLAUDE.md 中的规范只是告诉 AI "应该这样做"
- 但 AI 不会主动检查用户请求是否符合规范
- 缺少一个"守门员"角色来拦截不符合规范的请求

### 2.2 实现层面

当前插件缺少一个**流程执行器（Workflow Enforcer）**：

```
当前架构：
用户请求 → AI 直接响应 → 代码变更

期望架构：
用户请求 → 流程执行器检查 → 引导文档创建 → 基于文档生成代码
```

## 3. 解决方案需求

### 3.1 核心目标

创建一个新的 command：`enforce-doc-workflow`（或类似名称），用于：

1. **启用文档驱动开发强制模式**
2. **拦截所有代码变更请求**
3. **引导用户先完成需求文档和技术设计文档**
4. **只有在文档完成后才允许进行代码实现**

### 3.2 功能需求

#### F1: 流程强制执行模式

**能力描述**：
- 用户执行 `/enforce-doc-workflow` 后，进入"文档驱动开发强制模式"
- 在此模式下，AI 会拦截所有代码变更请求
- 强制用户先完成需求与技术方案，再进行代码实现
- 要求代码改动与技术方案一致，若不一致需先更新方案

**触发条件**：
- 用户请求中包含代码变更意图（如"添加"、"修改"、"实现"、"重构"等关键词）
- 检测到用户想要修改特定文件
- 用户使用 Write、Edit 等工具

#### F2: 智能意图识别

**能力描述**：
- 分析用户请求，识别是否为代码变更意图
- 区分不同类型的变更（新功能、bug 修复、重构、优化等）
- 根据变更类型提供定制化的文档模板

**识别规则**：

| 用户请求类型 | 关键词 | 需要的文档 |
|------------|--------|-----------|
| 新功能开发 | "添加"、"实现"、"新增" | 需求文档 + 技术设计 |
| Bug 修复 | "修复"、"解决"、"bug" | 缺陷分析 + 修复方案 |
| 代码重构 | "重构"、"优化"、"改进" | 重构目标 + 技术方案 |
| 性能优化 | "优化"、"性能"、"加速" | 性能分析 + 优化方案 |

#### F3: 文档完整性检查

**能力描述**：
- 在允许代码实现前，检查必需的文档是否存在
- 验证文档内容是否完整（不是空文件）
- 确认文档与当前变更请求相关

**检查清单**：
- [ ] 需求文档存在于 `docs/requirements/`
- [ ] 技术设计文档存在于 `docs/design/`
- [ ] 文档内容不为空（至少包含标题和主要章节）
- [ ] 文档版本号和状态标记正确

#### F4: 交互式文档创建引导

**能力描述**：
- 当检测到缺少文档时，引导用户创建文档
- 提供文档模板和结构建议
- 支持 AI 辅助生成文档草稿（基于用户描述）
- 允许用户编辑和确认文档内容
- init-doc-driven-dev 初始化时提供需求与技术方案模板
- 所有代码改动必须先检查方案一致性，确认后再继续

**模板要求**：
- 需求模板：`docs/standards/requirements-template.md`
- 技术方案模板：`docs/standards/technical-design-template.md`

**引导流程**：

```
步骤 1: 检测到代码变更请求
  ↓
步骤 2: 检查是否存在对应的需求文档
  ↓
  如果不存在 → 引导创建需求文档
  如果存在 → 继续下一步
  ↓
步骤 3: 检查是否存在对应的技术设计文档
  ↓
  如果不存在 → 引导创建技术设计文档
  如果存在 → 继续下一步
  ↓
步骤 4: 文档审查与确认
  ↓
步骤 5: 允许进行代码实现
```

#### F5: 流程状态管理

**能力描述**：
- 记录当前流程状态（正在创建需求文档、正在创建设计文档、允许代码实现）
- 支持流程暂停和恢复
- 允许用户查看当前流程进度

**状态定义**：

```typescript
type WorkflowState =
  | "idle"                    // 未启用强制模式
  | "enforcing"               // 已启用强制模式
  | "creating_requirements"   // 正在创建需求文档
  | "creating_design"         // 正在创建技术设计
  | "ready_for_implementation" // 文档完成，允许实现
  | "implementing"            // 正在实现代码
```

#### F6: 绕过机制（可选）

**能力描述**：
- 对于紧急 bug 修复或极小的改动，允许临时绕过文档流程
- 但需要用户明确确认，并记录绕过原因
- 事后提醒用户补充文档

**绕过条件**：
- 用户明确使用 `--skip-docs` 参数
- 用户在交互式确认中选择"跳过文档（不推荐）"
- 变更范围极小（如修改一个拼写错误）

### 3.3 命令设计

#### 命令名称

建议：`enforce-doc-workflow` 或 `enable-doc-workflow`

#### 命令参数

```bash
# 启用文档驱动开发强制模式
/enforce-doc-workflow

# 启用并设置严格级别
/enforce-doc-workflow --strict

# 禁用强制模式
/enforce-doc-workflow --disable

# 查看当前状态
/enforce-doc-workflow --status
```

#### 命令输出示例

**场景 1：启用强制模式**

```
🔒 文档驱动开发强制模式已启用

从现在开始，所有代码变更必须遵循以下流程：
  1️⃣ 创建需求文档（docs/requirements/）
  2️⃣ 创建技术设计文档（docs/design/）
  3️⃣ 基于文档进行代码实现

✅ AI 将自动拦截不符合规范的代码变更请求
✅ 引导您完成完整的文档驱动开发流程

提示：使用 /enforce-doc-workflow --disable 可以临时禁用此模式
```

**场景 2：拦截代码变更请求**

```
⚠️ 代码变更请求被拦截

您的请求："帮我在登录页面添加一个忘记密码的链接"

检测到此请求需要修改代码，但未找到对应的文档。
根据文档驱动开发规范，需要先完成以下步骤：

📋 第 1 步：创建需求文档
  建议文件名：docs/requirements/006-forgot-password-link.md
  需要包含：
    - 功能描述
    - 用户场景
    - 交互流程
    - 验收标准

❓ 是否现在开始创建需求文档？
  1. 是，AI 帮我生成文档草稿
  2. 是，我自己手动创建
  3. 跳过文档（不推荐，需要说明原因）
  4. 取消此次变更

请选择：
```

**场景 3：文档完成，允许实现**

```
✅ 文档审查通过

已完成的文档：
  📄 需求文档：docs/requirements/006-forgot-password-link.md
  📄 技术设计：docs/design/006-forgot-password-link-design.md

现在可以开始代码实现了。AI 将基于以上文档进行代码生成。

开始实现？[Y/n]
```

### 3.4 与现有能力的集成

该命令应该**作为其他 commands 和 skills 的前置守门员**：

- 在用户执行任何代码变更前，先检查文档完整性
- 调用 `doc-detector` 检测文档状态
- 调用 `doc-generator` 生成文档模板
- 调用 `pattern-extractor` 提供代码规范参考

**实现方式**：
- 使用 `AskUserQuestion` tool 进行交互式确认
- 使用 `Read/Write` tools 检查和创建文档
- 使用 `Task` tool 调用其他 skills
- 使用状态文件（如 `.doc-workflow-state.json`）记录流程状态

### 3.5 CLAUDE.md 集成

该命令启用后，应该在 CLAUDE.md 中添加以下内容：

```markdown
## 文档驱动开发强制模式（已启用）

⚠️ **重要提示**：此项目已启用文档驱动开发强制模式。

### AI 行为约束

- ❌ **禁止**直接响应代码变更请求
- ✅ **必须**先检查是否存在对应的需求文档和技术设计文档
- ✅ **必须**在缺少文档时引导用户先完成文档
- ✅ **必须**在文档完成后才能进行代码实现

### 流程检查点

在执行代码变更前，AI 必须确认：
1. [ ] 需求文档存在且内容完整
2. [ ] 技术设计文档存在且内容完整
3. [ ] 文档内容与当前变更请求相关
4. [ ] 用户已确认可以开始实现

### 绕过规则

仅在以下情况下允许跳过文档：
- 修复拼写错误或格式问题
- 紧急 bug 修复（需用户明确确认）
- 用户使用 `--skip-docs` 参数并说明原因

---
此配置由 `/enforce-doc-workflow` 命令生成
```

## 4. 技术实现建议

### 4.1 命令结构

```
ai-doc-driven-dev/
├── commands/
│   └── enforce-doc-workflow.md
└── skills/
    └── workflow-enforcer/
        └── SKILL.md
```

### 4.2 Frontmatter 定义

```markdown
---
name: enforce-doc-workflow
description: |
  Enable documentation-driven development enforcement mode.
  Intercepts all code change requests and enforces doc-first workflow.
  <example>Enable strict documentation-first workflow</example>
  <example>Check current workflow enforcement status</example>
allowed-tools: ["Read", "Write", "Edit", "Glob", "Grep", "Task", "AskUserQuestion"]
license: MIT
---
```

### 4.3 状态文件结构

```json
{
  "version": "1.0.0",
  "enforcementEnabled": true,
  "strictMode": false,
  "currentState": "enforcing",
  "activeTask": {
    "id": "006",
    "name": "Forgot Password Link",
    "type": "feature",
    "requiredDocs": {
      "requirements": {
        "path": "docs/requirements/006-forgot-password-link.md",
        "status": "completed"
      },
      "design": {
        "path": "docs/design/006-forgot-password-link-design.md",
        "status": "in_progress"
      }
    }
  },
  "bypassHistory": [],
  "timestamp": "2026-01-16T10:30:00Z"
}
```

### 4.4 意图识别实现

使用关键词匹配和上下文分析：

```typescript
const CODE_CHANGE_KEYWORDS = {
  feature: ["添加", "实现", "新增", "开发", "add", "implement", "create"],
  bugfix: ["修复", "解决", "bug", "fix", "resolve", "patch"],
  refactor: ["重构", "优化", "改进", "refactor", "optimize", "improve"],
  performance: ["性能", "加速", "优化", "performance", "speed up"]
};

function detectCodeChangeIntent(userRequest: string): {
  isCodeChange: boolean;
  changeType: string;
  confidence: number;
} {
  // 实现意图识别逻辑
}
```

## 5. 验收标准

### 5.1 功能验收

- [ ] 命令能够启用/禁用文档驱动开发强制模式
- [ ] 能够正确识别用户的代码变更意图
- [ ] 能够拦截不符合规范的代码变更请求
- [ ] 能够引导用户完成需求文档和技术设计文档
- [ ] 能够检查文档完整性并验证内容
- [ ] 支持流程状态管理和断点续传
- [ ] 提供合理的绕过机制

### 5.2 用户体验验收

- [ ] 拦截提示清晰友好，不让用户感到困惑
- [ ] 文档创建引导流程顺畅
- [ ] 支持 AI 辅助生成文档草稿
- [ ] 允许用户在必要时绕过流程（但有记录）

### 5.3 集成验收

- [ ] 与 CLAUDE.md 规范保持一致
- [ ] 与现有的 docs/ 目录结构兼容
- [ ] 能够调用现有的 skills（doc-detector, doc-generator 等）
- [ ] 不破坏现有功能

## 6. 优先级与影响

### 6.1 优先级评估

- **重要性**：极高（这是文档驱动开发流程的核心执行机制）
- **紧急性**：高（没有此功能，REQ-001 的价值大打折扣）
- **建议优先级**：P0（最高优先级）

### 6.2 影响范围

- **流程遵守性**：从"建议"变为"强制"，确保流程落地
- **代码质量**：所有代码变更都有文档支撑
- **可追溯性**：每个变更都能追溯到需求和设计文档
- **团队协作**：统一开发流程，提升协作效率

## 7. 风险与挑战

### 7.1 用户接受度风险

- **风险**：强制流程可能让用户觉得繁琐
- **缓解措施**：
  - 提供快速文档模板
  - AI 辅助生成文档草稿
  - 对小改动提供合理的绕过机制
  - 清晰说明文档驱动开发的价值

### 7.2 意图识别准确性

- **风险**：可能误判用户意图（将非代码变更请求识别为代码变更）
- **缓解措施**：
  - 提供明确的关键词列表
  - 允许用户纠正 AI 的判断
  - 记录误判案例并优化规则

### 7.3 流程灵活性

- **风险**：过于严格的流程可能影响开发效率
- **缓解措施**：
  - 提供严格模式和宽松模式选项
  - 允许项目自定义流程规则
  - 支持临时禁用强制模式

## 8. 后续优化方向

### 8.1 短期优化

- 支持自定义意图识别规则
- 提供更丰富的文档模板库
- 支持文档质量评分（检查文档是否足够详细）

### 8.2 长期优化

- 集成 AI 文档审查能力（检查文档逻辑是否合理）
- 支持团队协作场景（多人共同完成文档）
- 提供文档驱动开发的数据分析和改进建议

## 9. 待确认事项

- [ ] 命令的最终名称（`enforce-doc-workflow` 还是其他）
- [ ] 默认是否启用严格模式
- [ ] 绕过机制的具体规则
- [ ] 状态文件的存储位置和格式
- [ ] 是否需要与 Git hooks 集成（在 commit 前检查文档）

---

**解决此缺陷后，文档驱动开发流程将从"被动建议"变为"主动执行"，真正实现"先文档、再代码"的开发模式。**
